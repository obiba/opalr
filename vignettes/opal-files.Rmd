---
title: "Opal Files API"
author: "Yannick Marcon"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

Opal has an internal file system that is accessible through web services. The opal R package exposes files management related functions:

* upload a file,
* download a file or folder (optionaly encrypted),
* move or rename a file or folder,
* create a folder,
* remove a file or folder,
* write a file to the remote R session workspace,
* read a file from the remote R session workspace.

Setup the connection with Opal:

```{r}
library(opalr)
o <- opal.login("administrator", "password", "https://opal-demo.obiba.org")
```

Download a file:

```{r}
opal.file_download(o, "/tmp/datashield.zip")
```

Download a file, protected by a password:

```{r}
opal.file_download(o, "/tmp/datashield.zip", "datashield-encrypted.zip", key="ABCDEFGHIJKL")
```

Upload the file at another location:

```{r}
list.files()
opal.file_upload(o, "datashield.zip", "/projects/datashield")
```

Create a folder and list folder content:

```{r}
fooDir <- paste0("/projects/datashield/foo-", sample(10000:99999, 1))
opal.file_mkdir(o, fooDir)
knitr::kable(opal.file_ls(o, "/projects/datashield"))
```

Move file to the new folder and list folder content:

```{r}
opal.file_mv(o, "/projects/datashield/datashield.zip", fooDir)
knitr::kable(opal.file_ls(o, fooDir))
```

Rename the new folder and list folder content:

```{r}
barDir <- paste0("/projects/datashield/bar-", sample(10000:99999, 1))
opal.file_mv(o, fooDir, barDir)
knitr::kable(opal.file_ls(o, "/projects/datashield"))
```

Write a file from the Opal file system into the R server session workspace:

```{r}
opal.file_write(o, paste0(barDir, "/datashield.zip"))
opal.execute(o, "list.files()")
```

Read back the file into the Opal file system:

```{r}
opal.file_read(o, "datashield.zip", paste0(barDir, "/ds.zip"))
knitr::kable(opal.file_ls(o, barDir))
```


Remove created folder and list folder content:

```{r}
opal.file_rm(o, barDir)
knitr::kable(opal.file_ls(o, "/projects/datashield"))
```

Good practice is to free server resources by sending a logout request:

```{r}
# clean server side
opal.logout(o)
# clean client side
unlink("datashield-encrypted.zip")
unlink("datashield.zip")
```

